# Alembic Migration Workflow

## Quick Setup ‚úÖ
Alembic is configured and ready to use!

```bash
# Load environment
source .venv/Scripts/activate  # On Windows

# Check migration status
python -m alembic current
python -m alembic history
```

## Making Schema Changes

### 1Ô∏è‚É£ Update a Model
Edit any file in `database/models/` (e.g., add a new column):

```python
# database/models/runs.py
class Run(Base):
    __tablename__ = "runs"
    run_id = Column(String(36), primary_key=True, default=lambda: str(uuid.uuid4()))
    # NEW COLUMN:
    notes = Column(String(255), nullable=True)  # ‚Üê Added this
```

### 2Ô∏è‚É£ Generate Migration
```bash
python -m alembic revision --autogenerate -m "add notes column to runs"
```

This creates: `database/migrations/versions/20260111_xxxxxxx_add_notes_column_to_runs.py`

### 3Ô∏è‚É£ Review the Migration File
‚ö†Ô∏è **Always check the generated migration!**

```python
# database/migrations/versions/20260111_xxxxxxx_add_notes_column_to_runs.py

def upgrade() -> None:
    op.add_column('runs', 
        sa.Column('notes', sa.String(255), nullable=True)
    )

def downgrade() -> None:
    op.drop_column('runs', 'notes')
```

### 4Ô∏è‚É£ Apply the Migration
```bash
python -m alembic upgrade head
```

### 5Ô∏è‚É£ Commit to Git
```bash
git add database/migrations/versions/
git add alembic.ini
git commit -m "Add notes column to runs table"
```

## Common Commands

### Check Current Version
```bash
python -m alembic current
```

### View Migration History
```bash
python -m alembic history
```

### Rollback Last Migration
```bash
python -m alembic downgrade -1
```

### Rollback Multiple Migrations
```bash
python -m alembic downgrade -2  # Go back 2 versions
python -m alembic downgrade 6ca8998abe76  # Go to specific revision
```

## Team Collaboration

### Developer A & B Both Make Changes
```
Developer A:
  python -m alembic revision -m "add orders table"
  git commit & push

Developer B:
  python -m alembic revision -m "add payments table"
  git commit & push

Next person:
  git pull
  python -m alembic upgrade head  # Applies both
```

## Production Best Practices

‚úÖ **DO:**
- One migration per logical change
- Meaningful commit messages
- Review autogenerated migrations
- Test migrations locally first
- Run via CI/CD pipeline
- Keep production DB backups

‚ùå **DON'T:**
- Edit old migrations after release
- Manually modify schema without migrations
- Skip migration in development
- Run without testing

## Migration File Structure

```
database/migrations/
‚îú‚îÄ‚îÄ env.py                 # Alembic configuration
‚îú‚îÄ‚îÄ script.py.mako        # Migration template
‚îî‚îÄ‚îÄ versions/
    ‚îú‚îÄ‚îÄ 6ca8998abe76_initial_schema.py
    ‚îú‚îÄ‚îÄ 20260111_xxx_add_notes_to_runs.py
    ‚îî‚îÄ‚îÄ 20260111_yyy_add_status_to_work_orders.py
```

## Troubleshooting

### "No such table" during migration
Make sure DATABASE_URL is set in .env

### Migration doesn't run
Check if `alembic_version` table exists:
```sql
SELECT * FROM alembic_version;
```

### Conflict from two developers
Alembic auto-detects and handles merge conflicts. If needed:
```bash
python -m alembic merge --rev-id <id> -m "merge branches"
```

## When NOT to Use Alembic
- One-time schema setup (use `init_db.py`)
- Development environment reset
- Creating from scratch (tables already exist via `init_db.py`)

For migrations going forward ‚Üí **Always use Alembic** üöÄ
